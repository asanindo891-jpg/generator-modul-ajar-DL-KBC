<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Modul Ajar Kurikulum Merdeka</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #fee2e2, #fed7aa); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .status { text-align: right; font-size: 0.9em; margin-top: 10px; opacity: 0.9; }
        .buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95em; transition: transform 0.2s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); }
        .btn-gray { background: #6b7280; color: white; }
        .btn-green { background: #16a34a; color: white; }
        .btn-red { background: #dc2626; color: white; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-pink { background: #fecaca; color: #b91c1c; margin-left: auto; }
        .progress { background: #e5e7eb; height: 8px; border-radius: 10px; margin-bottom: 20px; }
        .progress-bar { background: #dc2626; height: 100%; transition: width 0.3s; border-radius: 10px; }
        .content { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); min-height: 400px; }
        .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .step { padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #f3f4f6; text-align: center; font-size: 0.85em; font-weight: 600; }
        .step.active { background: #dc2626; color: white; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #dc2626; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tip { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; }
        .template-box { background: #dbeafe; border: 2px solid #3b82f6; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .template-box h4 { color: #1e40af; margin-bottom: 15px; font-size: 1.1em; }
        .list-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: start; }
        .btn-remove { background: #ef4444; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; min-width: 40px; }
        .btn-add { background: white; color: #dc2626; border: 2px dashed #dc2626; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 600; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
        .footer { text-align: center; margin-top: 30px; padding: 20px; background: white; border-radius: 15px; color: #6b7280; font-size: 0.9em; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 2em; cursor: pointer; color: #6b7280; line-height: 1; }
        .saved-item { border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .saved-item h3 { color: #dc2626; margin-bottom: 5px; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .steps { grid-template-columns: 1fr; }
            .buttons { flex-direction: column; }
            .btn-pink { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Generator Modul Ajar</h1>
            <p>SD - SMP/MTS, SMA/MA/SMK | Kurikulum Merdeka - KBC</p>
            <div class="status" id="autoSaveStatus"></div>
        </div>

        <div class="buttons">
            <button class="btn btn-gray" onclick="showSaved()">üìÇ Modul Tersimpan</button>
            <button class="btn btn-green" onclick="saveModule()">üíæ Simpan Modul</button>
            <button class="btn btn-red" onclick="exportModule()">üì• Export File</button>
            <a href="https://bahasaindonesiama.blogspot.com" class="btn btn-pink" target="_blank">üè† Ke Blog</a>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 9%"></div>
        </div>

        <div class="steps" id="stepsContainer"></div>

        <div class="content" id="contentArea">
            <p style="color: #6b7280;">Loading...</p>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-gray" onclick="prevStep()" id="prevBtn">‚Üê Sebelumnya</button>
            <button class="btn btn-red" onclick="nextStep()" id="nextBtn">Lanjut ‚Üí</button>
        </div>

        <div class="footer">
            üîí 100% Aman - Data tersimpan lokal di browser Anda<br>
            Powered by <a href="https://bahasaindonesiama.blogspot.com" style="color: #dc2626; font-weight: bold; text-decoration: none;">BahasaIndonesiaMA.blogspot.com</a><br>
            <small style="opacity: 0.7;">v1.1.0 - Template System</small>
        </div>
    </div>

    <div id="savedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modul Tersimpan</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="savedList"></div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const steps = [
            {id: 'identitas', title: '1. Identitas'},
            {id: 'cp', title: '2. CP'},
            {id: 'tujuan', title: '3. Tujuan'},
            {id: 'pemahaman', title: '4. Pemahaman'},
            {id: 'pemantik', title: '5. Pertanyaan'},
            {id: 'pendahuluan', title: '6. Pendahuluan'},
            {id: 'inti', title: '7. Kegiatan Inti'},
            {id: 'penutup', title: '8. Penutup'},
            {id: 'asesmen', title: '9. Asesmen'},
            {id: 'diferensiasi', title: '10. Diferensiasi'},
            {id: 'media', title: '11. Media'}
        ];

        let formData = {
            satuan: '', mataPelajaran: '', fase: '', kelas: '', semester: '', alokasi: '',
            tahunPelajaran: '', penyusun: '', capaianPembelajaran: '',
            tujuanPembelajaran: [''], pemahamanBermakna: [''], pertanyaanPemantik: [''],
            kegiatanPendahuluan: '', kegiatanInti: '', kegiatanPenutup: '',
            asesmenDiagnostik: '', asesmenFormatif: '', asesmenSumatif: '',
            diferensiasiKonten: '', diferensiasiProses: '', diferensiasiProduk: '',
            p5Dimensi: [], p5Keterkaitan: '', mediaSumber: ['']
        };

        // DATABASE TEMPLATE
        const templateDatabase = {
            'Bahasa Indonesia': {
                'Teks Anekdot': {
                    fase: 'E',
                    kelas: 'X',
                    cp: 'Peserta didik mampu memahami, menganalisis struktur dan kaidah kebahasaan, serta memproduksi teks anekdot dengan memperhatikan konteks sosial budaya, tujuan, dan pemirsa.',
                    tujuan: [
                        'Menganalisis struktur teks anekdot (abstraksi, orientasi, krisis, reaksi, dan koda)',
                        'Mengevaluasi penggunaan majas dan gaya bahasa dalam teks anekdot',
                        'Menciptakan teks anekdot dengan tema aktual dan mengandung kritik sosial'
                    ],
                    pemahaman: [
                        'Teks anekdot merupakan cara efektif menyampaikan kritik sosial dengan gaya yang menghibur',
                        'Struktur teks anekdot membantu penyampaian pesan yang terorganisir dan mudah dipahami'
                    ],
                    pemantik: [
                        'Mengapa kritik sosial lebih efektif disampaikan melalui cerita lucu?',
                        'Bagaimana anekdot dapat mempengaruhi cara pandang masyarakat?',
                        'Apa perbedaan anekdot dengan humor biasa?'
                    ],
                    pendahuluan: '1. Guru membuka pembelajaran dengan salam dan doa\n2. Apersepsi: Guru menanyakan pengalaman siswa mendengar atau membaca cerita lucu yang mengandung sindiran\n3. Guru menyampaikan tujuan pembelajaran tentang teks anekdot\n4. Guru memotivasi siswa dengan menjelaskan relevansi teks anekdot dalam kehidupan sehari-hari',
                    inti: 'Tahap Eksplorasi:\n- Siswa mengamati beberapa contoh teks anekdot dari berbagai sumber\n- Siswa mengidentifikasi ciri-ciri dan struktur teks anekdot\n\nTahap Elaborasi:\n- Diskusi kelompok: menganalisis struktur dan kaidah kebahasaan teks anekdot\n- Siswa membandingkan beberapa teks anekdot dan mengidentifikasi keunggulan masing-masing\n- Siswa mengumpulkan ide untuk membuat teks anekdot sendiri\n\nTahap Kreasi:\n- Siswa menyusun teks anekdot dengan tema aktual\n- Presentasi hasil karya dan saling memberikan umpan balik',
                    penutup: '1. Siswa bersama guru menyimpulkan materi tentang teks anekdot\n2. Refleksi: Apa yang sudah dipahami? Apa tantangan dalam membuat teks anekdot?\n3. Guru memberikan penguatan dan apresiasi\n4. Guru menginformasikan pembelajaran selanjutnya tentang publikasi teks anekdot',
                    asesmenDiagnostik: 'Observasi pemahaman awal siswa tentang teks anekdot melalui tanya jawab',
                    asesmenFormatif: 'Penilaian selama diskusi kelompok dan proses penyusunan teks anekdot',
                    asesmenSumatif: 'Penilaian produk teks anekdot dan presentasi dengan rubrik yang mencakup struktur, kaidah kebahasaan, dan kreativitas',
                    diferensiasiKonten: 'Menyediakan contoh teks anekdot dengan tingkat kompleksitas berbeda sesuai kemampuan siswa',
                    diferensiasiProses: 'Siswa dapat bekerja individu atau berpasangan sesuai gaya belajar',
                    diferensiasiProduk: 'Siswa dapat memilih membuat teks anekdot tertulis, komik, atau video pendek',
                    p5Dimensi: ['Bernalar Kritis', 'Kreatif'],
                    p5Keterkaitan: 'Pembelajaran ini mengembangkan kemampuan bernalar kritis dalam menganalisis fenomena sosial dan kreatif dalam menyampaikan kritik konstruktif, sejalan dengan nilai Rahmatan lil Alamin dalam memberikan manfaat bagi sesama melalui kritik yang membangun.',
                    mediaSumber: ['Buku teks Bahasa Indonesia Kelas X', 'Video contoh teks anekdot', 'LKPD analisis struktur teks', 'Portal berita online']
                },
                'Teks Eksposisi': {
                    fase: 'E',
                    kelas: 'X',
                    cp: 'Peserta didik mampu memahami, menganalisis, dan memproduksi teks eksposisi dengan memperhatikan struktur, kaidah kebahasaan, serta argumentasi yang logis.',
                    tujuan: [
                        'Menganalisis struktur teks eksposisi (tesis, argumen, penegasan ulang)',
                        'Mengevaluasi kekuatan argumentasi dalam teks eksposisi',
                        'Menciptakan teks eksposisi dengan tema aktual dan argumentasi yang logis'
                    ],
                    pemahaman: [
                        'Teks eksposisi membantu menyampaikan informasi dan pendapat secara sistematis',
                        'Argumentasi yang kuat memerlukan data dan fakta yang valid'
                    ],
                    pemantik: [
                        'Mengapa argumentasi yang logis penting dalam menyampaikan pendapat?',
                        'Bagaimana membedakan fakta dan opini dalam teks eksposisi?',
                        'Apa dampak teks eksposisi yang baik bagi pembaca?'
                    ],
                    pendahuluan: '1. Guru membuka dengan salam dan doa\n2. Apersepsi: menanyakan pengalaman siswa membaca artikel opini\n3. Menyampaikan tujuan pembelajaran\n4. Memotivasi dengan contoh teks eksposisi aktual',
                    inti: 'Eksplorasi: Siswa membaca berbagai teks eksposisi\nElaborasi: Diskusi dan analisis struktur serta argumentasi\nKreasi: Menyusun teks eksposisi dengan tema pilihan',
                    penutup: '1. Kesimpulan materi\n2. Refleksi pembelajaran\n3. Penguatan\n4. Informasi pembelajaran berikutnya',
                    asesmenDiagnostik: 'Pertanyaan lisan tentang pemahaman awal teks eksposisi',
                    asesmenFormatif: 'Penilaian diskusi dan draft teks eksposisi',
                    asesmenSumatif: 'Penilaian produk teks eksposisi final',
                    diferensiasiKonten: 'Teks dengan tingkat kompleksitas bervariasi',
                    diferensiasiProses: 'Kerja individu atau kelompok',
                    diferensiasiProduk: 'Artikel, infografis, atau video eksposisi',
                    p5Dimensi: ['Bernalar Kritis', 'Mandiri'],
                    p5Keterkaitan: 'Mengembangkan pemikiran kritis dan kemampuan berargumentasi untuk kebaikan bersama',
                    mediaSumber: ['Buku teks', 'Artikel koran', 'Video tutorial', 'LKPD']
                }
            },
            'Matematika': {
                'Trigonometri': {
                    fase: 'E',
                    kelas: 'X',
                    cp: 'Peserta didik mampu memahami konsep perbandingan trigonometri pada segitiga siku-siku, menggunakan identitas trigonometri, dan menerapkannya dalam pemecahan masalah kontekstual.',
                    tujuan: [
                        'Menganalisis hubungan antara sudut dan sisi dalam segitiga siku-siku menggunakan perbandingan trigonometri',
                        'Mengevaluasi penerapan identitas trigonometri dalam berbagai kasus',
                        'Memecahkan masalah kontekstual yang berkaitan dengan trigonometri'
                    ],
                    pemahaman: [
                        'Trigonometri membantu menghitung jarak dan sudut yang sulit diukur langsung dalam kehidupan nyata',
                        'Konsep trigonometri diterapkan dalam navigasi, arsitektur, dan astronomi'
                    ],
                    pemantik: [
                        'Bagaimana arsitek menentukan kemiringan atap yang ideal?',
                        'Mengapa pilot pesawat perlu memahami trigonometri?',
                        'Bagaimana menghitung tinggi gedung tanpa mengukurnya langsung?'
                    ],
                    pendahuluan: '1. Salam dan doa\n2. Apersepsi: menunjukkan aplikasi trigonometri dalam kehidupan\n3. Menyampaikan tujuan pembelajaran\n4. Motivasi dengan video penerapan trigonometri',
                    inti: 'Eksplorasi: Siswa mengamati segitiga siku-siku dan mengidentifikasi perbandingan sisi\nElaborasi: Diskusi kelompok menyelesaikan masalah trigonometri\nKreasi: Membuat proyek pengukuran tinggi benda menggunakan trigonometri',
                    penutup: '1. Kesimpulan tentang konsep trigonometri\n2. Refleksi: Apa manfaat trigonometri?\n3. Penguatan dan apresiasi\n4. Informasi materi berikutnya',
                    asesmenDiagnostik: 'Tes awal pemahaman konsep segitiga dan sudut',
                    asesmenFormatif: 'Observasi selama diskusi dan latihan soal',
                    asesmenSumatif: 'Tes tertulis dan proyek pengukuran',
                    diferensiasiKonten: 'Soal dengan tingkat kesulitan bertingkat',
                    diferensiasiProses: 'Bantuan scaffolding untuk siswa yang membutuhkan',
                    diferensiasiProduk: 'Laporan tertulis atau presentasi video',
                    p5Dimensi: ['Bernalar Kritis', 'Kreatif'],
                    p5Keterkaitan: 'Menggunakan matematika untuk memecahkan masalah nyata dan memberikan solusi bermanfaat',
                    mediaSumber: ['Buku Matematika Kelas X', 'GeoGebra', 'Video simulasi', 'Alat ukur (busur, penggaris)']
                }
            },
            'IPA': {
                'Sistem Pencernaan': {
                    fase: 'D',
                    kelas: 'VIII',
                    cp: 'Peserta didik mampu memahami, menganalisis struktur dan fungsi sistem pencernaan manusia, serta menerapkan pola hidup sehat untuk menjaga kesehatan sistem pencernaan.',
                    tujuan: [
                        'Menganalisis hubungan antara struktur organ pencernaan dengan fungsinya',
                        'Mengevaluasi dampak pola makan terhadap kesehatan sistem pencernaan',
                        'Merancang program pola makan sehat untuk menjaga sistem pencernaan'
                    ],
                    pemahaman: [
                        'Sistem pencernaan yang sehat penting untuk penyerapan nutrisi optimal',
                        'Pola makan dan gaya hidup sangat mempengaruhi kesehatan pencernaan'
                    ],
                    pemantik: [
                        'Mengapa kita perlu mengunyah makanan dengan baik?',
                        'Apa yang terjadi jika sistem pencernaan kita bermasalah?',
                        'Bagaimana makanan yang kita makan diubah menjadi energi?'
                    ],
                    pendahuluan: '1. Salam dan doa\n2. Apersepsi: bertanya tentang makanan favorit siswa\n3. Menyampaikan tujuan tentang sistem pencernaan\n4. Motivasi dengan video proses pencernaan',
                    inti: 'Eksplorasi: Mengamati torso sistem pencernaan\nElaborasi: Diskusi tentang proses pencernaan dari mulut hingga anus\nKreasi: Membuat poster pola makan sehat',
                    penutup: '1. Kesimpulan tentang sistem pencernaan\n2. Refleksi: Apa yang akan diubah dari pola makan?\n3. Penguatan\n4. Tugas mengamati pola makan sendiri',
                    asesmenDiagnostik: 'Tanya jawab pemahaman awal tentang pencernaan',
                    asesmenFormatif: 'Observasi diskusi dan pembuatan poster',
                    asesmenSumatif: 'Tes tertulis dan presentasi program makan sehat',
                    diferensiasiKonten: 'Video animasi dan teks dengan kompleksitas berbeda',
                    diferensiasiProses: 'Kerja kelompok atau individu sesuai pilihan',
                    diferensiasiProduk: 'Poster, infografis, atau video edukasi',
                    p5Dimensi: ['Beriman', 'Mandiri'],
                    p5Keterkaitan: 'Menjaga kesehatan tubuh sebagai amanah dan berbagi pengetahuan untuk kesehatan bersama',
                    mediaSumber: ['Buku IPA Kelas VIII', 'Torso sistem pencernaan', 'Video animasi', 'Leaflet kesehatan']
                }
            }
        };

        window.onload = function() {
            init();
        };

        function init() {
            renderSteps();
            renderContent();
            updateProgress();
            startAutoSave();
        }

        function renderSteps() {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = steps.map((step, i) => 
                '<div class="step ' + (i === currentStep ? 'active' : '') + '" onclick="goToStep(' + i + ')">' + step.title + '</div>'
            ).join('');
        }

        function showTemplateSelector() {
            const mapel = formData.mataPelajaran;
            if (!mapel) {
                return '<div class="template-box" style="background:#fee2e2; border-color:#dc2626;"><p style="color:#991b1b;">‚ö†Ô∏è <strong>Isi Mata Pelajaran terlebih dahulu</strong> untuk melihat template yang tersedia</p></div>';
            }

            const templates = templateDatabase[mapel];
            if (!templates) {
                return '<div class="template-box" style="background:#fef3c7; border-color:#f59e0b;"><p style="color:#92400e;">üìã Template untuk mata pelajaran <strong>' + mapel + '</strong> sedang dalam pengembangan. Silakan isi manual.</p></div>';
            }

            let html = '<div class="template-box">';
            html += '<h4>‚ö° Mau lebih cepat? Gunakan Template Siap Pakai!</h4>';
            html += '<p style="margin-bottom:15px; font-size:0.9em;">Pilih topik di bawah, semua bagian akan otomatis terisi. Anda bisa edit sesuai kebutuhan.</p>';
            html += '<div class="form-group"><label>Pilih Topik:</label><select id="topikTemplate" style="font-size:1em;">';
            html += '<option value="">-- Pilih Topik --</option>';
            Object.keys(templates).forEach(function(topik) {
                html += '<option value="' + topik + '">' + topik + '</option>';
            });
            html += '</select></div>';
            html += '<button onclick="loadTemplate()" class="btn btn-blue" style="width:100%; padding:15px; font-size:1.05em;">‚ú® Muat Template Sekarang</button>';
            html += '<p style="margin-top:10px; font-size:0.85em; color:#6b7280;">üí° <strong>Tips:</strong> Template akan mengisi 90% modul. Review dan sesuaikan dengan kondisi kelas Anda.</p>';
            html += '</div>';
            return html;
        }

        function loadTemplate() {
            const mapel = formData.mataPelajaran;
            const topik = document.getElementById('topikTemplate').value;

            if (!topik) {
                alert('‚ö†Ô∏è Pilih topik terlebih dahulu!');
                return;
            }

            const template = templateDatabase[mapel][topik];
            if (template) {
                formData.capaianPembelajaran = template.cp;
                formData.tujuanPembelajaran = template.tujuan.slice();
                formData.pemahamanBermakna = template.pemahaman.slice();
                formData.pertanyaanPemantik = template.pemantik.slice();
                formData.kegiatanPendahuluan = template.pendahuluan;
                formData.kegiatanInti = template.inti;
                formData.kegiatanPenutup = template.penutup;
                formData.asesmenDiagnostik = template.asesmenDiagnostik;
                formData.asesmenFormatif = template.asesmenFormatif;
                formData.asesmenSumatif = template.asesmenSumatif;
                formData.diferensiasiKonten = template.diferensiasiKonten;
                formData.diferensiasiProses = template.diferensiasiProses;
                formData.diferensiasiProduk = template.diferensiasiProduk;
                formData.p5Dimensi = template.p5Dimensi.slice();
                formData.p5Keterkaitan = template.p5Keterkaitan;
                formData.mediaSumber = template.mediaSumber.slice();

                // Update fase dan kelas jika cocok
                if (formData.fase === '' || formData.kelas === '') {
                    formData.fase = template.fase || formData.fase;
                    formData.kelas = template.kelas || formData.kelas;
                }

                renderContent();
                alert('‚úÖ Template berhasil dimuat!\n\nüìù Semua bagian telah terisi otomatis.\nüí° Silakan review dan edit sesuai kebutuhan kelas Anda.\n\n‚û°Ô∏è Klik "Lanjut" untuk melihat hasilnya!');
            }
        }

        function renderContent() {
            const content = document.getElementById('contentArea');
            const step = steps[currentStep];

            if (step.id === 'identitas') {
                content.innerHTML = '<h2>Identitas Pembelajaran</h2>' +
                    showTemplateSelector() +
                    '<div class="form-group"><label>Satuan Pendidikan</label>' +
                    '<select onchange="updateField(\'satuan\', this.value)">' +
                    '<option value="">Pilih Satuan Pendidikan</option>' +
                    '<option value="SD"' + (formData.satuan==='SD'?' selected':'') + '>SD</option>' +
                    '<option value="SMP"' + (formData.satuan==='SMP'?' selected':'') + '>SMP</option>' +
                    '<option value="MTS"' + (formData.satuan==='MTS'?' selected':'') + '>MTS</option>' +
                    '<option value="SMA"' + (formData.satuan==='SMA'?' selected':'') + '>SMA</option>' +
                    '<option value="MA"' + (formData.satuan==='MA'?' selected':'') + '>MA</option>' +
                    '<option value="SMK"' + (formData.satuan==='SMK'?' selected':'') + '>SMK</option>' +
                    '</select></div>' +
                    '<div class="form-group"><label>Mata Pelajaran</label>' +
                    '<input type="text" placeholder="Contoh: Matematika, Bahasa Indonesia" value="' + formData.mataPelajaran + '" onchange="updateField(\'mataPelajaran\', this.value); renderContent();"></div>' +
                    '<div class="grid-2">' +
                    '<div class="form-group"><label>Fase</label>' +
                    '<select onchange="updateField(\'fase\', this.value)">' +
                    '<option value="">Pilih Fase</option>' +
                    '<option value="A"' + (formData.fase==='A'?' selected':'') + '>Fase A (Kelas 1-2)</option>' +
                    '<option value="B"' + (formData.fase==='B'?' selected':'') + '>Fase B (Kelas 3-4)</option>' +
                    '<option value="C"' + (formData.fase==='C'?' selected':'') + '>Fase C (Kelas 5-6)</option>' +
                    '<option value="D"' + (formData.fase==='D'?' selected':'') + '>Fase D (Kelas 7-9)</option>' +
                    '<option value="E"' + (formData.fase==='E'?' selected':'') + '>Fase E (Kelas 10)</option>' +
                    '<option value="F"' + (formData.fase==='F'?' selected':'') + '>Fase F (Kelas 11-12)</option>' +
                    '</select></div>' +
                    '<div class="form-group"><label>Kelas</label>' +
                    '<input type="text" placeholder="VII, X, 5" value="' + formData.kelas + '" onchange="updateField(\'kelas\', this.value)"></div>' +
                    '</div>' +
                    '<div class="grid-2">' +
                    '<div class="form-group"><label>Semester</label>' +
                    '<select onchange="updateField(\'semester\', this.value)">' +
                    '<option value="">Pilih Semester</option>' +
                    '<option value="1"' + (formData.semester==='1'?' selected':'') + '>Semester 1</option>' +
                    '<option value="2"' + (formData.semester==='2'?' selected':'') + '>Semester 2</option>' +
                    '</select></div>' +
                    '<div class="form-group"><label>Alokasi Waktu</label>' +
                    '<input type="text" placeholder="2 x 45 menit" value="' + formData.alokasi + '" onchange="updateField(\'alokasi\', this.value)"></div>' +
                    '</div>' +
                    '<div class="form-group"><label>Tahun Pelajaran</label>' +
                    '<input type="text" placeholder="2024/2025" value="' + formData.tahunPelajaran + '" onchange="updateField(\'tahunPelajaran\', this.value)"></div>' +
                    '<div class="form-group"><label>Penyusun</label>' +
                    '<input type="text" placeholder="Nama Anda" value="' + formData.penyusun + '" onchange="updateField(\'penyusun\', this.value)"></div>';
            } else if (step.id === 'cp') {
                content.innerHTML = '<h2>Capaian Pembelajaran (CP)</h2>' +
                    '<div class="tip">üí° <strong>Tips:</strong> Capaian Pembelajaran mengacu pada dokumen resmi Kurikulum Merdeka</div>' +
                    '<div class="form-group"><label>Capaian Pembelajaran</label>' +
                    '<textarea rows="8" placeholder="Peserta didik mampu..." onchange="updateField(\'capaianPembelajaran\', this.value)">' + formData.capaianPembelajaran + '</textarea></div>';
            } else if (step.id === 'tujuan') {
                let html = '<h2>Tujuan Pembelajaran (HOTS)</h2>' +
                    '<div class="tip">üí° <strong>Gunakan Kata Kerja HOTS:</strong><br>' +
                    '<button class="btn btn-add" style="display:inline-block; width:auto; margin:5px; padding:8px 15px;" onclick="insertKata(\'Menganalisis \')">Menganalisis</button>' +
                    '<button class="btn btn-add" style="display:inline-block; width:auto; margin:5px; padding:8px 15px;" onclick="insertKata(\'Mengevaluasi \')">Mengevaluasi</button>' +
                    '<button class="btn btn-add" style="display:inline-block; width:auto; margin:5px; padding:8px 15px;" onclick="insertKata(\'Menciptakan \')">Menciptakan</button>' +
                    '</div><div id="tujuanList">';
                formData.tujuanPembelajaran.forEach(function(t, i) {
                    html += '<div class="list-item">' +
                        '<textarea rows="2" placeholder="Tujuan ' + (i+1) + '" onchange="updateListItem(\'tujuanPembelajaran\', ' + i + ', this.value)">' + t + '</textarea>';
                    if (formData.tujuanPembelajaran.length > 1) {
                        html += '<button class="btn-remove" onclick="removeListItem(\'tujuanPembelajaran\', ' + i + ')">‚úï</button>';
                    }
                    html += '</div>';
                });
                html += '</div><button class="btn-add" onclick="addListItem(\'tujuanPembelajaran\')">+ Tambah Tujuan</button>';
                content.innerHTML = html;
            } else if (step.id === 'pemahaman') {
                let html = '<h2>Pemahaman Bermakna</h2>' +
                    '<div class="tip">üí° <strong>Tips:</strong> Jelaskan pemahaman yang relevan dengan kehidupan nyata</div><div>';
                formData.pemahamanBermakna.forEach(function(p, i) {
                    html += '<div class="list-item">' +
                        '<textarea rows="2" placeholder="Pemahaman ' + (i+1) + '" onchange="updateListItem(\'pemahamanBermakna\', ' + i + ', this.value)">' + p + '</textarea>';
                    if (formData.pemahamanBermakna.length > 1) {
                        html += '<button class="btn-remove" onclick="removeListItem(\'pemahamanBermakna\', ' + i + ')">‚úï</button>';
                    }
                    html += '</div>';
                });
                html += '</div><button class="btn-add" onclick="addListItem(\'pemahamanBermakna\')">+ Tambah Pemahaman</button>';
                content.innerHTML = html;
            } else if (step.id === 'pemantik') {
                let html = '<h2>Pertanyaan Pemantik</h2>' +
                    '<div class="tip">üí° <strong>Contoh:</strong> Mengapa... penting? Bagaimana dampak...?</div><div>';
                formData.pertanyaanPemantik.forEach(function(p, i) {
                    html += '<div class="list-item">' +
                        '<input type="text" placeholder="Pertanyaan ' + (i+1) + '" value="' + p + '" onchange="updateListItem(\'pertanyaanPemantik\', ' + i + ', this.value)">';
                    if (formData.pertanyaanPemantik.length > 1) {
                        html += '<button class="btn-remove" onclick="removeListItem(\'pertanyaanPemantik\', ' + i + ')">‚úï</button>';
                    }
                    html += '</div>';
                });
                html += '</div><button class="btn-add" onclick="addListItem(\'pertanyaanPemantik\')">+ Tambah Pertanyaan</button>';
                content.innerHTML = html;
            } else if (step.id === 'pendahuluan') {
                content.innerHTML = '<h2>Kegiatan Pendahuluan</h2>' +
                    '<div class="tip">üí° Salam, Apersepsi, Tujuan, Motivasi</div>' +
                    '<div class="form-group"><textarea rows="8" placeholder="1. Guru membuka dengan salam..." onchange="updateField(\'kegiatanPendahuluan\', this.value)">' + formData.kegiatanPendahuluan + '</textarea></div>';
            } else if (step.id === 'inti') {
                content.innerHTML = '<h2>Kegiatan Inti</h2>' +
                    '<div class="tip">üí° Eksplorasi ‚Üí Elaborasi ‚Üí Aksi/Kreasi</div>' +
                    '<div class="form-group"><textarea rows="10" placeholder="Tahap Eksplorasi..." onchange="updateField(\'kegiatanInti\', this.value)">' + formData.kegiatanInti + '</textarea></div>';
            } else if (step.id === 'penutup') {
                content.innerHTML = '<h2>Penutup & Refleksi</h2>' +
                    '<div class="tip">üí° Kesimpulan, Refleksi, Penguatan</div>' +
                    '<div class="form-group"><textarea rows="8" placeholder="1. Kesimpulan bersama..." onchange="updateField(\'kegiatanPenutup\', this.value)">' + formData.kegiatanPenutup + '</textarea></div>';
            } else if (step.id === 'asesmen') {
                content.innerHTML = '<h2>Asesmen Autentik</h2>' +
                    '<div class="form-group"><label>Asesmen Diagnostik</label>' +
                    '<textarea rows="4" placeholder="Observasi awal..." onchange="updateField(\'asesmenDiagnostik\', this.value)">' + formData.asesmenDiagnostik + '</textarea></div>' +
                    '<div class="form-group"><label>Asesmen Formatif</label>' +
                    '<textarea rows="4" placeholder="Penilaian selama proses..." onchange="updateField(\'asesmenFormatif\', this.value)">' + formData.asesmenFormatif + '</textarea></div>' +
                    '<div class="form-group"><label>Asesmen Sumatif</label>' +
                    '<textarea rows="4" placeholder="Penilaian akhir..." onchange="updateField(\'asesmenSumatif\', this.value)">' + formData.asesmenSumatif + '</textarea></div>';
            } else if (step.id === 'diferensiasi') {
                let html = '<h2>Diferensiasi & P5 RA</h2>' +
                    '<div class="form-group"><label>Diferensiasi Konten</label>' +
                    '<textarea rows="3" onchange="updateField(\'diferensiasiKonten\', this.value)">' + formData.diferensiasiKonten + '</textarea></div>' +
                    '<div class="form-group"><label>Diferensiasi Proses</label>' +
                    '<textarea rows="3" onchange="updateField(\'diferensiasiProses\', this.value)">' + formData.diferensiasiProses + '</textarea></div>' +
                    '<div class="form-group"><label>Diferensiasi Produk</label>' +
                    '<textarea rows="3" onchange="updateField(\'diferensiasiProduk\', this.value)">' + formData.diferensiasiProduk + '</textarea></div>' +
                    '<div class="form-group" style="margin-top:25px;"><label style="margin-bottom:12px;">Dimensi Profil Pelajar Pancasila</label>';
                ['Beriman dan bertakwa kepada Tuhan YME', 'Berkebinekaan global', 'Bergotong royong', 'Mandiri', 'Bernalar kritis', 'Kreatif'].forEach(function(d) {
                    var checked = formData.p5Dimensi.indexOf(d) > -1 || 
                                  (d === 'Beriman dan bertakwa kepada Tuhan YME' && formData.p5Dimensi.indexOf('Beriman') > -1) ||
                                  (d === 'Berkebinekaan global' && formData.p5Dimensi.indexOf('Berkebinekaan') > -1) ||
                                  (d === 'Bergotong royong' && formData.p5Dimensi.indexOf('Gotong Royong') > -1) ||
                                  (d === 'Bernalar kritis' && formData.p5Dimensi.indexOf('Bernalar Kritis') > -1);
                    html += '<div style="display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid #f3f4f6;">' +
                        '<input type="checkbox" style="width:18px; height:18px; cursor:pointer; flex-shrink:0;"' + (checked ?' checked':'') + ' onchange="toggleP5(\'' + d + '\')">' +
                        '<label style="font-weight:normal; margin:0; cursor:pointer; flex:1;" onclick="this.previousElementSibling.click()">' + d + '</label>' +
                        '</div>';
                });
                html += '</div><div class="form-group" style="margin-top:25px;"><label>Keterkaitan P5 & Rahmatan lil Alamin</label>' +
                    '<textarea rows="4" placeholder="Jelaskan bagaimana pembelajaran ini berkaitan dengan P5 dan nilai Rahmatan lil Alamin..." onchange="updateField(\'p5Keterkaitan\', this.value)">' + formData.p5Keterkaitan + '</textarea></div>';
                content.innerHTML = html;
            } else if (step.id === 'media') {
                let html = '<h2>Media & Sumber Belajar</h2><div>';
                formData.mediaSumber.forEach(function(m, i) {
                    html += '<div class="list-item">' +
                        '<input type="text" placeholder="Media/Sumber ' + (i+1) + '" value="' + m + '" onchange="updateListItem(\'mediaSumber\', ' + i + ', this.value)">';
                    if (formData.mediaSumber.length > 1) {
                        html += '<button class="btn-remove" onclick="removeListItem(\'mediaSumber\', ' + i + ')">‚úï</button>';
                    }
                    html += '</div>';
                });
                html += '</div><button class="btn-add" onclick="addListItem(\'mediaSumber\')">+ Tambah Media/Sumber</button>';
                content.innerHTML = html;
            }

            updateNavigationButtons();
        }

        function updateField(field, value) {
            formData[field] = value;
        }

        function updateListItem(field, index, value) {
            formData[field][index] = value;
        }

        function addListItem(field) {
            formData[field].push('');
            renderContent();
        }

        function removeListItem(field, index) {
            formData[field].splice(index, 1);
            renderContent();
        }

        function toggleP5(dimension) {
            // Mapping nama lengkap ke nama pendek untuk kompatibilitas template
            var dimensionMap = {
                'Beriman dan bertakwa kepada Tuhan YME': 'Beriman',
                'Berkebinekaan global': 'Berkebinekaan',
                'Bergotong royong': 'Gotong Royong',
                'Mandiri': 'Mandiri',
                'Bernalar kritis': 'Bernalar Kritis',
                'Kreatif': 'Kreatif'
            };
            
            var mappedDimension = dimensionMap[dimension] || dimension;
            var idx = formData.p5Dimensi.indexOf(mappedDimension);
            
            if (idx > -1) {
                formData.p5Dimensi.splice(idx, 1);
            } else {
                formData.p5Dimensi.push(mappedDimension);
            }
        }

        function insertKata(kata) {
            alert('üí° Copy kata ini dan paste di textarea Tujuan: ' + kata);
        }

        function goToStep(index) {
            currentStep = index;
            renderSteps();
            renderContent();
            updateProgress();
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderSteps();
                renderContent();
                updateProgress();
            }
        }

        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                renderSteps();
                renderContent();
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = ((currentStep + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentStep === 0;
            document.getElementById('prevBtn').style.opacity = currentStep === 0 ? '0.5' : '1';
            document.getElementById('nextBtn').disabled = currentStep === steps.length - 1;
            document.getElementById('nextBtn').style.opacity = currentStep === steps.length - 1 ? '0.5' : '1';
        }

        function saveModule() {
            const id = 'modul_' + Date.now();
            const data = { id: id, savedAt: new Date().toLocaleString('id-ID') };
            Object.assign(data, formData);
            localStorage.setItem(id, JSON.stringify(data));
            alert('‚úÖ Modul berhasil disimpan!');
        }

        function startAutoSave() {
            setInterval(function() {
                if (formData.satuan || formData.mataPelajaran) {
                    document.getElementById('autoSaveStatus').textContent = 'üíæ Tersimpan otomatis';
                    setTimeout(function() {
                        document.getElementById('autoSaveStatus').textContent = '';
                    }, 2000);
                }
            }, 30000);
        }

        function exportModule() {
            let content = 'MODUL AJAR KURIKULUM MERDEKA\n\n';
            content += 'A. IDENTITAS PEMBELAJARAN\n';
            content += '- Satuan Pendidikan: ' + formData.satuan + '\n';
            content += '- Mata Pelajaran: ' + formData.mataPelajaran + '\n';
            content += '- Fase/Kelas: ' + formData.fase + '/' + formData.kelas + '\n';
            content += '- Semester: ' + formData.semester + '\n';
            content += '- Alokasi Waktu: ' + formData.alokasi + '\n';
            content += '- Tahun Pelajaran: ' + formData.tahunPelajaran + '\n';
            content += '- Penyusun: ' + formData.penyusun + '\n\n';
            content += 'B. CAPAIAN PEMBELAJARAN\n' + formData.capaianPembelajaran + '\n\n';
            content += 'C. TUJUAN PEMBELAJARAN\n';
            formData.tujuanPembelajaran.filter(function(t) { return t; }).forEach(function(t, i) {
                content += (i + 1) + '. ' + t + '\n';
            });
            content += '\nD. PEMAHAMAN BERMAKNA\n';
            formData.pemahamanBermakna.filter(function(p) { return p; }).forEach(function(p) {
                content += '- ' + p + '\n';
            });
            content += '\nE. PERTANYAAN PEMANTIK\n';
            formData.pertanyaanPemantik.filter(function(p) { return p; }).forEach(function(p) {
                content += '- ' + p + '\n';
            });
            content += '\nF. KEGIATAN PENDAHULUAN\n' + formData.kegiatanPendahuluan + '\n\n';
            content += 'G. KEGIATAN INTI\n' + formData.kegiatanInti + '\n\n';
            content += 'H. PENUTUP DAN REFLEKSI\n' + formData.kegiatanPenutup + '\n\n';
            content += 'I. ASESMEN AUTENTIK\n';
            content += 'Asesmen Diagnostik: ' + formData.asesmenDiagnostik + '\n';
            content += 'Asesmen Formatif: ' + formData.asesmenFormatif + '\n';
            content += 'Asesmen Sumatif: ' + formData.asesmenSumatif + '\n\n';
            content += 'J. DIFERENSIASI & P5 RA\n';
            content += 'Konten: ' + formData.diferensiasiKonten + '\n';
            content += 'Proses: ' + formData.diferensiasiProses + '\n';
            content += 'Produk: ' + formData.diferensiasiProduk + '\n';
            content += 'Dimensi P5: ' + formData.p5Dimensi.join(', ') + '\n';
            content += 'Keterkaitan: ' + formData.p5Keterkaitan + '\n\n';
            content += 'K. MEDIA DAN SUMBER\n';
            formData.mediaSumber.filter(function(m) { return m; }).forEach(function(m) {
                content += '- ' + m + '\n';
            });
            content += '\n---\nDibuat dengan Generator Modul Ajar - BahasaIndonesiaMA.blogspot.com';

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Modul_Ajar_' + (formData.mataPelajaran || 'Draft') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function showSaved() {
            const modal = document.getElementById('savedModal');
            const list = document.getElementById('savedList');
            let html = '';
            let hasModules = false;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('modul_')) {
                    hasModules = true;
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        html += '<div class="saved-item">';
                        html += '<h3>' + (data.mataPelajaran || 'Draft') + '</h3>';
                        html += '<p style="color:#6b7280; font-size:0.9em;">' + data.satuan + ' - Kelas ' + data.kelas + '</p>';
                        html += '<p style="color:#6b7280; font-size:0.85em; margin-top:5px;">Disimpan: ' + data.savedAt + '</p>';
                        html += '<div style="display:flex; gap:10px; margin-top:10px;">';
                        html += '<button class="btn btn-red" style="font-size:0.9em;" onclick="loadModule(\'' + key + '\')">Muat</button>';
                        html += '<button class="btn btn-gray" style="font-size:0.9em;" onclick="deleteModule(\'' + key + '\')">Hapus</button>';
                        html += '</div></div>';
                    } catch (e) {
                        console.log('Error loading module:', e);
                    }
                }
            }

            if (!hasModules) {
                html = '<p style="text-align:center; color:#6b7280; padding:40px;">Belum ada modul yang tersimpan</p>';
            }

            list.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('savedModal').style.display = 'none';
        }

        function loadModule(key) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                Object.assign(formData, data);
                currentStep = 0;
                renderSteps();
                renderContent();
                updateProgress();
                closeModal();
                alert('‚úÖ Modul berhasil dimuat!');
            } catch (e) {
                alert('‚ùå Gagal memuat modul');
            }
        }

        function deleteModule(key) {
            if (confirm('Yakin ingin menghapus modul ini?')) {
                localStorage.removeItem(key);
                showSaved();
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('savedModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
